name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '18.x'
  AZURE_CONTAINER_REGISTRY: acrtatsukonidemov1
  REPOSITORY_NAME: servicebus-receiver
  CONTAINER_APP_NAME: my-container-app-v1
  CONTAINER_APP_ENVIRONMENT: my-environment-v1
  RESOURCE_GROUP: tatsukoni-test-v2
  SERVIVE_BUS_NAMESPACE: sb-tatsukoni-demo-v1
  SERVICE_BUS_TOPIC_NAME: mytopic
  COSMOS_CONNECTION_STRING: ${{ secrets.COSMOS_CONNECTION_STRING }}

jobs:
  # container imageをレジストリにbuild & pushする
  build:
    runs-on: ubuntu-latest
    outputs:
      CONTAINER_IMAGE_TAG: ${{ steps.tag.outputs.CONTAINER_IMAGE_TAG }}
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_CONTAINER_DEPLOY }}

      - name: Set container image tag
        id: tag
        run: |
          echo "CONTAINER_IMAGE_TAG=$(date +%Y%m%d%H%M%S)-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push image
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
          username: ${{ secrets.AZURE_CREDENTIALS_CLIENT_ID }}
          password: ${{ secrets.AZURE_CREDENTIALS_CLIENT_SECRET }}
      - run: |
          docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.REPOSITORY_NAME }}:${{ steps.tag.outputs.CONTAINER_IMAGE_TAG }} .
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.REPOSITORY_NAME }}:${{ steps.tag.outputs.CONTAINER_IMAGE_TAG }}

      - name: "Logout via Azure CLI"
        run: |
          az logout

  # Service Bus のキュー配信を停止(サブスクリプションルールを入れ替える)
  stop-queue:
    runs-on: ubuntu-latest
    needs: build
    outputs:
      CURRENT_ACTIVE_SUBSCRIPTION: ${{ steps.current-active-subscription.outputs.CURRENT_ACTIVE_SUBSCRIPTION }}
      CURRENT_ACTIVE_SUBSCRIPTION_FILTER: ${{ steps.current-not-active-subscription.outputs.CURRENT_ACTIVE_SUBSCRIPTION_FILTER }}
      CURRENT_NOT_ACTIVE_SUBSCRIPTION: ${{ steps.current-not-active-subscription.outputs.CURRENT_NOT_ACTIVE_SUBSCRIPTION }}
      CURRENT_NOT_ACTIVE_SUBSCRIPTION_FILTER: ${{ steps.current-not-active-subscription.outputs.CURRENT_NOT_ACTIVE_SUBSCRIPTION_FILTER }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_CONTAINER_DEPLOY }}

      - name: Get Current Active Subscription
        id: current-active-subscription
        run: |
          currentActiveSubscription=$(az containerapp list \
            --environment ${{ env.CONTAINER_APP_ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[].properties.template.containers[].env[]" -o json | jq -r '.[] | select(.name=="SUBSCRIPTION_NAME").value')
          echo "CURRENT_ACTIVE_SUBSCRIPTION=$currentActiveSubscription" >> $GITHUB_OUTPUT

      - name: Get Current Not Active Subscription
        id: current-not-active-subscription
        run: |
          if [ "${{ steps.current-active-subscription.outputs.CURRENT_ACTIVE_SUBSCRIPTION }}" = "blue" ]; then
            echo "CURRENT_NOT_ACTIVE_SUBSCRIPTION=green" >> $GITHUB_OUTPUT
            echo "CURRENT_ACTIVE_SUBSCRIPTION_FILTER=BlueFilter" >> $GITHUB_OUTPUT
            echo "CURRENT_NOT_ACTIVE_SUBSCRIPTION_FILTER=GreenFilter" >> $GITHUB_OUTPUT
          elif [ "${{ steps.current-active-subscription.outputs.CURRENT_ACTIVE_SUBSCRIPTION }}" = "green" ]; then
            echo "CURRENT_NOT_ACTIVE_SUBSCRIPTION=blue" >> $GITHUB_OUTPUT
            echo "CURRENT_ACTIVE_SUBSCRIPTION_FILTER=GreenFilter" >> $GITHUB_OUTPUT
            echo "CURRENT_NOT_ACTIVE_SUBSCRIPTION_FILTER=BlueFilter" >> $GITHUB_OUTPUT
          fi

      # キューはAt Least Onceで配信しているので、先に両方のサブスクリプションを有効化してから、現在配信中のサブスクリプションを停止する
      - name: Update subscription rule
        run: |
          echo "Current Active Subscription: ${{ steps.current-active-subscription.outputs.CURRENT_ACTIVE_SUBSCRIPTION }}"
          echo "Current Not Active Subscription: ${{ steps.current-not-active-subscription.outputs.CURRENT_NOT_ACTIVE_SUBSCRIPTION }}"
          az servicebus topic subscription rule update \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --namespace-name ${{ env.SERVIVE_BUS_NAMESPACE }} \
            --topic-name ${{ env.SERVICE_BUS_TOPIC_NAME }} \
            --subscription-name ${{ steps.current-not-active-subscription.outputs.CURRENT_NOT_ACTIVE_SUBSCRIPTION }} \
            --name ${{ steps.current-not-active-subscription.outputs.CURRENT_NOT_ACTIVE_SUBSCRIPTION_FILTER }} \
            --filter-sql-expression 1=1
          az servicebus topic subscription rule update \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --namespace-name ${{ env.SERVIVE_BUS_NAMESPACE }} \
            --topic-name ${{ env.SERVICE_BUS_TOPIC_NAME }} \
            --subscription-name ${{ steps.current-active-subscription.outputs.CURRENT_ACTIVE_SUBSCRIPTION }} \
            --name ${{ steps.current-not-active-subscription.outputs.CURRENT_ACTIVE_SUBSCRIPTION_FILTER }} \
            --filter-sql-expression 1=0

      - name: "Logout via Azure CLI"
        run: |
          az logout

  # container appをデプロイする
  # TODO: Templateファイルを使ってデプロイする
  # TODO: 機密の環境変数はSecretで管理する
  deploy:
    runs-on: ubuntu-latest
    needs: [build, stop-queue]
    outputs:
      CURRENT_CONTAINER_REVISION: ${{ steps.current-container-revision.outputs.CURRENT_CONTAINER_REVISION }}
      DEPLOY_CONTAINER_REVISION: ${{ steps.deploy-container-revision.outputs.DEPLOY_CONTAINER_REVISION }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_CONTAINER_DEPLOY }}

      # デプロイ実施前に、現在稼働しているコンテナのリビジョンを取得しておく
      - name: Get Current Container Revision
        id: current-container-revision
        run: |
          currentContainerRevision=$(az containerapp list \
            --environment ${{ env.CONTAINER_APP_ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[].properties.latestRevisionName" \
            -o tsv)
          echo "CURRENT_CONTAINER_REVISION=$currentContainerRevision" >> $GITHUB_OUTPUT

      - name: Set Deploy Container Revision
        id: deploy-container-revision
        run: |
          echo "DEPLOY_CONTAINER_REVISION=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Deploy container app
        run: |
          az containerapp create \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APP_ENVIRONMENT }} \
            --min-replicas 1 \
            --max-replicas 1 \
            --revision-suffix ${{ steps.deploy-container-revision.outputs.DEPLOY_CONTAINER_REVISION }} \
            --env-vars \
              "SUBSCRIPTION_NAME=${{ needs.stop-queue.outputs.CURRENT_NOT_ACTIVE_SUBSCRIPTION }}" \
              "REVISION_SUFFIX=${{ steps.deploy-container-revision.outputs.DEPLOY_CONTAINER_REVISION }}" \
              "CONNECTION_STRING=${{ secrets.SERVICE_BUS_CONNECTION_STRING }}" \
              "COSMOS_CONNECTION_STRING=${{ env.COSMOS_CONNECTION_STRING }}" \
            --image ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.REPOSITORY_NAME }}:${{ needs.build.outputs.CONTAINER_IMAGE_TAG }} \
            --registry-username ${{ env.AZURE_CONTAINER_REGISTRY }} \
            --registry-password ${{ secrets.REGISTRY_PASSWORD }} \
            --registry-server ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io \
            --revisions-mode multiple

      - name: "Logout via Azure CLI"
        run: |
          az logout

  # 稼働中のワーカー処理が0になったら、旧コンテナリビジョンを非アクティブ化する
  deactivate-old-revision:
    runs-on: ubuntu-latest
    needs: [build, stop-queue, deploy]
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_CONTAINER_DEPLOY }}

      - name: Setup Node ${{ env.NODE_VERSION }} Environment
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Node Modules
        run: |
          npm install

      - name: Check and wait
        id: check_loop
        run: |
          for i in {1..10}; do
            count=$(node count.js ${{ needs.deploy.outputs.CURRENT_CONTAINER_REVISION }})
            echo "Attempt $i: Process count is $count"
            if [ "$count" == "0" ]; then
              echo "WORKER_COUNT=0" >> $GITHUB_ENV
              break
            elif [ "$i" -eq 10 ]; then
              echo "WORKER_COUNT=$count" >> $GITHUB_ENV
              echo "Process count is not 0. Exit." >&2
              exit 1
            else
              sleep 30
            fi
          done

      - name: Deactivate old container revision
        if: env.WORKER_COUNT.count == '0'
        run: |
          az containerapp revision deactivate \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision ${{ needs.deploy.outputs.CURRENT_CONTAINER_REVISION }} \

      - name: "Logout via Azure CLI"
        run: |
          az logout
